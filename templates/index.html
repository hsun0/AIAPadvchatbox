<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Cohere 聊天機器人</title>
    <link rel="icon" href="/static/images/iconR.png" type="image/x-icon" />
    <!-- 如果使用 Font Awesome，取消註解以下行 -->
    <!--
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pk0jRv0L/JSt5sC6BqNRB7X+FsO2Thk9qU0x+VGqCqIu/6YcWB+g5l5rP+M2sN7N8VgjQlKc3E6Yf/NfE1D3lw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    -->
    <style>
        body { font-family: Arial, sans-serif; background-color: #f2f2f2; }
        #chat-window { 
            width: 500px; 
            height: 600px; 
            border: 1px solid #ccc; 
            padding: 10px; 
            overflow-y: scroll; 
            margin: 20px auto; 
            background-color: #fff; 
            border-radius: 5px;
        }
        #input-area { 
            width: 500px; 
            margin: 10px auto; 
            display: flex; 
            align-items: center; 
        }
        #change-icon { 
            width: 40px; 
            height: 40px; 
            border: none; 
            background: none; 
            cursor: pointer; 
            padding: 0; 
            margin-right: 10px; 
        }
        #change-icon img { 
            width: 100%; 
            height: 100%; 
            border-radius: 50%; 
        }
        #message { 
            flex: 1; 
            padding: 10px; 
            font-size: 16px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
        }
        #send { 
            padding: 10px 20px; 
            font-size: 16px; 
            margin-left: 10px; 
            border: none;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        #send:hover {
            background-color: #45a049;
        }
        #clear { 
            padding: 10px 20px; 
            font-size: 16px; 
            margin-left: 10px; 
            border: none;
            background-color: #f44336;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        #clear:hover {
            background-color: #da190b;
        }
        .message { 
            display: flex; 
            align-items: flex-start; 
            margin: 10px 0; 
        }
        .message .icon {
            margin-right: 10px;
            width: 40px;
            height: 40px;
        }
        .message .icon img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        .message .text {
            background-color: #e6e6e6;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .message .text::after {
            content: "";
            position: absolute;
            top: 10px;
            left: -10px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent #e6e6e6 transparent transparent;
        }
        /* Bot messages alignment */
        .bot .message {
            flex-direction: row;
        }
        .user .message {
            flex-direction: row-reverse;
        }
        .user .text::after {
            left: auto;
            right: -10px;
            border-color: transparent transparent transparent #e6e6e6;
        }
        /* 添加時間戳樣式 */
        .message .timestamp {
            font-size: 12px;
            color: #888;
            text-align: right;
            margin-top: 5px;
        }
        /* 新增功能按鈕的容器 */
        .action-buttons {
            display: flex;
            gap: 10px; /* 按鈕之間的間距 */
            margin-top: 5px; /* 與訊息框的間距 */
        }

        /* 功能按鈕的樣式 */
        .action-button {
            width: 20px; /* 按鈕寬度為 20px */
            height: 20px; /* 按鈕高度為 20px */
            border: none;
            background: none;
            padding: 0;
            cursor: pointer;
        }

        .action-button img {
            width: 100%;
            height: 100%;
            border-radius: 3px; /* 圓角 */
        }
    </style>
</head>
<body>
    <h1 style="text-align:center;">Cohere 聊天機器人</h1>
    <div id="chat-window"></div>
    <div id="input-area">
        <button id="change-icon">
            <img src="/static/images/iconE.png" alt="User Icon" id="current-icon">
        </button>
        <input type="text" id="message" placeholder="輸入您的訊息..." />
        <button id="send">送出</button>
        <button id="clear">清除對話</button>
    </div>

    <script>
        const sendButton = document.getElementById('send');
        const clearButton = document.getElementById('clear');
        const messageInput = document.getElementById('message');
        const chatWindow = document.getElementById('chat-window');
        const changeIconButton = document.getElementById('change-icon');
        const currentIconImg = document.getElementById('current-icon');

        // 定義使用者圖示陣列
        const userIcons = [
            '/static/images/iconE.png',
            '/static/images/iconF.png',
            '/static/images/iconM.png'
        ];
        let currentIconIndex = 0;

        // 在頁面加載時，從 localStorage 讀取 currentIconIndex
        document.addEventListener('DOMContentLoaded', () => {
            const storedIndex = localStorage.getItem('currentIconIndex');
            if (storedIndex !== null && !isNaN(storedIndex)) {
                currentIconIndex = parseInt(storedIndex, 10);
                currentIconImg.src = userIcons[currentIconIndex];
            }
        });

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        clearButton.addEventListener('click', clearConversation);
        changeIconButton.addEventListener('click', changeUserIcon);

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message === '') return;

            appendMessage('user', message);
            messageInput.value = '';

            fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                appendMessage('bot', data.response);
            })
            .catch(error => {
                console.error('Error:', error);
                appendMessage('bot', '抱歉，發生錯誤。');
            });
        }

        function appendMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = sender;

            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = 'message';

            const iconDiv = document.createElement('div');
            iconDiv.className = 'icon';

            if (sender === 'user') {
                iconDiv.innerHTML = `<img src="${userIcons[currentIconIndex]}" alt="User Icon" class="user-icon">`;
            } else {
                iconDiv.innerHTML = '<img src="/static/images/iconR.png" alt="Bot Icon">';
            }

            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            textDiv.textContent = text;

            // 添加時間戳
            const timeStamp = document.createElement('div');
            timeStamp.className = 'timestamp';
            const now = new Date();
            timeStamp.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            textDiv.appendChild(timeStamp);

            // 如果是使用者訊息，添加功能按鈕
            if (sender === 'user') {
                const actionButtonsDiv = document.createElement('div');
                actionButtonsDiv.className = 'action-buttons';

                // 定義功能按鈕及其圖示
                const actions = [
                    { name: 'redo', normal: '/static/images/REDO.png', clicked: '/static/images/REDOclicked.png' },
                    { name: 'edit', normal: '/static/images/EDIT.png', clicked: '/static/images/EDITclicked.png' },
                    { name: 'listen', normal: '/static/images/LISTEN.png', clicked: '/static/images/LISTENclicked.png' },
                    { name: 'speak', normal: '/static/images/SPEAK.png', clicked: '/static/images/SPEAKclicked.png' },
                    { name: 'think', normal: '/static/images/THINK.png', clicked: '/static/images/THINKclicked.png' }
                ];

                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.className = 'action-button';
                    button.id = `${action.name}-button`;

                    const img = document.createElement('img');
                    img.src = action.normal;
                    img.alt = `${action.name} icon`;

                    button.appendChild(img);
                    actionButtonsDiv.appendChild(button);

                    // 添加事件監聽器
                    button.addEventListener('mousedown', () => {
                        img.src = action.clicked;
                    });

                    button.addEventListener('mouseup', () => {
                        img.src = action.normal;
                    });

                    button.addEventListener('mouseleave', () => {
                        img.src = action.normal;
                    });
                });

                textDiv.appendChild(actionButtonsDiv);
            }

            messageContentDiv.appendChild(iconDiv);
            messageContentDiv.appendChild(textDiv);
            messageDiv.appendChild(messageContentDiv);
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function clearConversation() {
            fetch('/api/clear', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success'){
                    chatWindow.innerHTML = '';
                    alert('對話已清除。');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function changeUserIcon() {
            // 增加索引並循環
            currentIconIndex = (currentIconIndex + 1) % userIcons.length;
            // 更新按鈕上的圖示
            currentIconImg.src = userIcons[currentIconIndex];
            // 更新所有使用者訊息中的圖示
            const userIconElements = document.querySelectorAll('.user-icon');
            userIconElements.forEach(img => {
                img.src = userIcons[currentIconIndex];
            });
            // 儲存當前圖示索引到 localStorage
            localStorage.setItem('currentIconIndex', currentIconIndex);
        }
    </script>
</body>
</html>
